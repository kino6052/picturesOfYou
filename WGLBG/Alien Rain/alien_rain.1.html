<html>

<head>
<title>WebGL Beginner's Guide - Chapter 3 - Goraud Shading + Lambertian Reflection Model</title>
<meta http-equiv='content-type' content='text/html; charset=ISO-8859-1'>

<!-- CSS Styles //-->
<link href='css/style.css'   type='text/css' rel='stylesheet'>
<link href='css/desert.css'  type='text/css' rel='stylesheet'/>
<link href='css/colorpicker.css'  type='text/css' rel='stylesheet'/>
<link href='css/smoothness/jquery-ui-1.8.13.custom.css' type='text/css' rel='stylesheet' />

<!-- JavaScript Libraries //-->
<script type='text/javascript' src='js/gl-matrix-min.js'></script>
<script type='text/javascript' src='js/jquery-1.5.1.min.js'></script>
<script type='text/javascript' src='js/jquery-ui-1.8.13.custom.min.js'></script> 
<script type='text/javascript' src='js/prettify.js'></script>
<script type='text/javascript' src='js/utils.js'></script>
<script type='text/javascript' src='js/colorpicker.js'></script>
<script type='text/javascript' src='js/codeview.js'></script>

<script id="shader-vs" type="x-shader/x-vertex">
attribute vec3 aVertexPosition;
attribute vec3 aVertexNormal;
//attribute vec2 aTextureCoord;

uniform mat4 uMVMatrix;
uniform mat4 uPMatrix;
uniform mat4 uNMatrix;

uniform vec3 uLightDirection;   //light direction
uniform vec4 uLightDiffuse;     //light color
uniform vec4 uMaterialDiffuse;  //object color

//varying vec2 vTextureCoord;

varying vec4 vFinalColor;

void main(void) {
 //Transformed normal position
 vec3 N = normalize(vec3(uNMatrix * vec4(aVertexNormal, 1.0)));
    
 //Normalize light to calculate lambertTerm
 vec3 L = normalize(uLightDirection);
 
 //Lambert's cosine law
 float lambertTerm = dot(N,-L);
 
 //Final Color
 vec4 Id = uMaterialDiffuse * uLightDiffuse * lambertTerm;
 vFinalColor = Id;
 vFinalColor.a = 1.0;
    
  //Transformed vertex position
  gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
  //vTextureCoord = aTextureCoord;
}
</script>

<script id="shader-fs" type="x-shader/x-fragment">
#ifdef GL_ES
precision highp float;
#endif

uniform sampler2D uSampler;
//varying vec2 vTextureCoord;
varying vec4  vFinalColor;

void main(void)  {
 gl_FragColor = vFinalColor; //texture2D(uSampler, vTextureCoord);

}
</script>


<script id='code-js' type="text/javascript">

var gl = null; // WebGL context
var prg = null; // The program (shaders)
var c_width = 0; // Variable to store the width of the canvas
var c_height = 0; // Variable to store the height of the canvas

var mvMatrix = mat4.create(); // The Model-View matrix
var pMatrix = mat4.create(); // The projection matrix

/*-----------------------------------------------------*/
var nMatrix =  mat4.create();       // The normal matrix
/*-----------------------------------------------------*/

var sphereVerticesBuffer;
var sphereIndicesBuffer;
var dataArrayBuffer;

/*-----------------------------------------------------*/
var sphereNormalsBuffer;               //VBO for Normals
/*-----------------------------------------------------*/
var dropletIndicesBuffer;
var cubeVertexTextureCoordBuffer;

var vertices;
var indices;
/*-----------------------------------------------------*/
var normals;              //JavaScript Array for Normals
/*-----------------------------------------------------*/
var textureCoords;
var affineTransformationsArray = [];

var angle = 0;

// Droplet Properties
var dropletQuantity = 100;
var speed = 0.01;
var rotationSpeed = 0.01;
var spread = 3000;

function initAffineTransformationsArray(){
	affineTransformationsArray = []; // start with an empty array
	for (var i = 0; i < dropletQuantity; i++) {
		affineTransformationsArray[i] = new Array(0, 0, 0, 0, 0, 0);
		// Random angles
		affineTransformationsArray[i][0] = ((Math.random() * 1000) % 360) ; 
		affineTransformationsArray[i][1] = ((Math.random() * 1000) % 360) ; 
		affineTransformationsArray[i][2] = ((Math.random() * 1000) % 360) ; 
		affineTransformationsArray[i][3] = ((Math.random() * 10000) % spread - spread/2) / 1000; 
		affineTransformationsArray[i][4] = 10-((Math.random() * 10000) % 10000) / 1000; 
		affineTransformationsArray[i][5] = ((Math.random() * 10000) % spread - spread/2) / 1000; 
	}
	console.log(affineTransformationsArray);
}

function updateAffineTransformationsArray(){
	for (var i = 0; i < dropletQuantity; i++) {
		// Random angles
		affineTransformationsArray[i][1] -= rotationSpeed; affineTransformationsArray[i][1] = affineTransformationsArray[i][1] % 360;  // fall
		affineTransformationsArray[i][4] -= speed; 
		if (affineTransformationsArray[i][4] < -5){
		    affineTransformationsArray[i][4] = 5;
		}
	}
}

/**
* The program contains a series of instructions that tell the Graphic Processing Unit (GPU)
* what to do with every vertex and fragment that we pass it. 
* The vertex shader and the fragment shader together are called the program.
*/
function initProgram() {
    var fragmentShader          = utils.getShader(gl, "shader-fs");
    var vertexShader            = utils.getShader(gl, "shader-vs");

    prg = gl.createProgram();
    gl.attachShader(prg, vertexShader);
    gl.attachShader(prg, fragmentShader);
    gl.linkProgram(prg);

    if (!gl.getProgramParameter(prg, gl.LINK_STATUS)) {
        alert("Could not initialise shaders");
    }

    gl.useProgram(prg);

    prg.aVertexPosition  = gl.getAttribLocation(prg, "aVertexPosition");
    prg.aVertexNormal    = gl.getAttribLocation(prg, "aVertexNormal");
    prg.aTextureCoord = gl.getAttribLocation(prg, "aTextureCoord");
    gl.enableVertexAttribArray(prg.aTextureCoord);
	
    prg.uPMatrix         = gl.getUniformLocation(prg, "uPMatrix");
    prg.uMVMatrix        = gl.getUniformLocation(prg, "uMVMatrix");
    prg.uNMatrix         = gl.getUniformLocation(prg, "uNMatrix");

    prg.uMaterialDiffuse  = gl.getUniformLocation(prg, "uMaterialDiffuse");
    prg.uLightDiffuse     = gl.getUniformLocation(prg, "uLightDiffuse");
    prg.uLightDirection   = gl.getUniformLocation(prg, "uLightDirection");
    
    prg.samplerUniform = gl.getUniformLocation(prg, "uSampler");
}


function initLights(){
    gl.uniform3fv(prg.uLightDirection,    [0.0, -1.0, -1.0]);
    gl.uniform4fv(prg.uLightDiffuse,      [1.0,1.0,1.0,1.0]); 
    gl.uniform4fv(prg.uMaterialDiffuse,   [0.5,0.8,0.1,1.0]);
}

/**
* This function generates SPHERE data and creates the buffers
*/
function initBuffers()
{
    vertices = [0.437499, 0.095984, 0.439012, -0.437501, 0.095984, 0.439012, 0.499999, 0.025671, 0.360887, -0.500001, 0.025671, 0.360887, 0.546874, -0.013391, 0.251512, -0.546876, -0.013391, 0.251512, 0.351562, -0.091516, 0.290575, -0.351563, -0.091516, 0.290575, 0.351562, -0.036829, 0.392137, -0.351563, -0.036829, 0.392137, 0.351562, 0.064734, 0.454637, -0.351563, 0.064734, 0.454637, 0.273437, 0.095984, 0.470262, -0.273438, 0.095984, 0.470262, 0.203124, 0.025671, 0.415575, -0.203126, 0.025671, 0.415575, 0.156249, -0.013391, 0.321825, -0.156251, -0.013391, 0.321825, 0.078124, 0.174109, 0.329637, -0.078126, 0.174109, 0.329637, 0.140624, 0.174109, 0.415575, -0.140626, 0.174109, 0.415575, 0.242187, 0.174109, 0.470262, -0.242188, 0.174109, 0.470262, 0.273437, 0.260046, 0.470262, -0.273438, 0.260046, 0.470262, 0.203124, 0.322546, 0.415575, -0.203126, 0.322546, 0.415575, 0.156249, 0.369421, 0.321825, -0.156251, 0.369421, 0.321825, 0.351562, 0.447546, 0.290575, -0.351563, 0.447546, 0.290575, 0.351562, 0.385046, 0.392137, -0.351563, 0.385046, 0.392137, 0.351562, 0.291296, 0.454637, -0.351563, 0.291296, 0.454637, 0.437499, 0.260046, 0.439012, -0.437501, 0.260046, 0.439012, 0.499999, 0.322546, 0.360887, -0.500001, 0.322546, 0.360887, 0.546874, 0.369421, 0.251512, -0.546876, 0.369421, 0.251512, 0.624999, 0.174109, 0.235887, -0.625001, 0.174109, 0.235887, 0.562499, 0.174109, 0.345262, -0.562501, 0.174109, 0.345262, 0.468749, 0.174109, 0.4312, -0.468751, 0.174109, 0.4312, 0.476562, 0.174109, 0.446825, -0.476563, 0.174109, 0.446825, 0.445312, 0.267859, 0.454637, -0.445313, 0.267859, 0.454637, 0.351562, 0.306921, 0.478075, -0.351563, 0.306921, 0.478075, 0.265624, 0.267859, 0.4937, -0.265626, 0.267859, 0.4937, 0.226562, 0.174109, 0.4937, -0.226563, 0.174109, 0.4937, 0.265624, 0.088171, 0.4937, -0.265626, 0.088171, 0.4937, 0.351562, 0.174109, 0.501512, -0.351563, 0.174109, 0.501512, 0.351562, 0.049109, 0.478075, -0.351563, 0.049109, 0.478075, 0.445312, 0.088171, 0.454637, -0.445313, 0.088171, 0.454637, -1e-06, 0.361609, 0.415575, -1e-06, 0.283484, 0.4937, -1e-06, -0.747766, 0.407762, -1e-06, -0.388391, 0.454637, -1e-06, -0.255579, 0.470262, -1e-06, -0.841516, 0.392137, -1e-06, 0.338171, 0.27495, -1e-06, 0.502234, 0.2437, -1e-06, 0.830359, -0.873488, -1e-06, 0.494421, -1.17817, -1e-06, 0.002234, -1.15474, -1e-06, -0.450891, -0.678175, 0.203124, -0.255579, 0.235887, -0.203126, -0.255579, 0.235887, 0.312499, -0.505579, 0.2437, -0.312501, -0.505579, 0.2437, 0.351562, -0.763391, 0.2437, -0.351563, -0.763391, 0.2437, 0.367187, -0.958704, 0.204637, -0.367188, -0.958704, 0.204637, 0.328124, -1.01339, 0.196825, -0.328126, -1.01339, 0.196825, 0.179687, -1.03683, 0.228075, -0.179688, -1.03683, 0.228075, -1e-06, -1.05245, 0.251512, 0.437499, -0.208704, 0.204637, -0.437501, -0.208704, 0.204637, 0.632812, -0.107141, 0.21245, -0.632813, -0.107141, 0.21245, 0.828124, 0.080359, 0.1187, -0.828126, 0.080359, 0.1187, 0.859374, 0.361609, 0.267137, -0.859376, 0.361609, 0.267137, 0.710937, 0.416296, 0.298387, -0.710938, 0.416296, 0.298387, 0.492187, 0.533484, 0.360887, -0.492188, 0.533484, 0.360887, 0.320312, 0.689734, 0.407762, -0.320313, 0.689734, 0.407762, 0.156249, 0.650671, 0.4312, -0.156251, 0.650671, 0.4312, 0.062499, 0.424109, 0.423387, -0.062501, 0.424109, 0.423387, 0.164062, 0.345984, 0.446825, -0.164063, 0.345984, 0.446825, 0.124999, 0.236609, 0.439012, -0.125001, 0.236609, 0.439012, 0.203124, 0.025671, 0.415575, -0.203126, 0.025671, 0.415575, 0.374999, -0.052454, 0.376512, -0.375001, -0.052454, 0.376512, 0.492187, -0.005579, 0.345262, -0.492188, -0.005579, 0.345262, 0.624999, 0.119421, 0.321825, -0.625001, 0.119421, 0.321825, 0.640624, 0.228796, 0.321825, -0.640626, 0.228796, 0.321825, 0.601562, 0.306921, 0.33745, -0.601563, 0.306921, 0.33745, 0.429687, 0.369421, 0.392137, -0.429688, 0.369421, 0.392137, 0.249999, 0.400671, 0.4312, -0.250001, 0.400671, 0.4312, -1e-06, -0.833704, 0.407762, 0.109374, -0.786829, 0.407762, -0.109376, -0.786829, 0.407762, 0.117187, -0.904016, 0.384325, -0.117188, -0.904016, 0.384325, 0.062499, -0.950891, 0.3687, -0.062501, -0.950891, 0.3687, -1e-06, -0.958704, 0.360887, -1e-06, -0.263391, 0.423387, -1e-06, -0.208704, 0.415575, 0.101562, -0.216516, 0.415575, -0.101563, -0.216516, 0.415575, 0.124999, -0.294641, 0.423387, -0.125001, -0.294641, 0.423387, 0.085937, -0.357141, 0.415575, -0.085938, -0.357141, 0.415575, 0.398437, -0.114954, 0.345262, -0.398438, -0.114954, 0.345262, 0.617187, -0.013391, 0.298387, -0.617188, -0.013391, 0.298387, 0.726562, 0.135046, 0.27495, -0.726563, 0.135046, 0.27495, 0.742187, 0.306921, 0.329637, -0.742188, 0.306921, 0.329637, 0.687499, 0.345984, 0.39995, -0.687501, 0.345984, 0.39995, 0.437499, 0.478796, 0.470262, -0.437501, 0.478796, 0.470262, 0.312499, 0.572546, 0.509325, -0.312501, 0.572546, 0.509325, 0.203124, 0.549109, 0.52495, -0.203126, 0.549109, 0.52495, 0.101562, 0.361609, 0.517137, -0.101563, 0.361609, 0.517137, 0.124999, -0.169641, 0.485887, -0.125001, -0.169641, 0.485887, 0.210937, -0.513391, 0.384325, -0.210938, -0.513391, 0.384325, 0.249999, -0.771204, 0.360887, -0.250001, -0.771204, 0.360887, 0.265624, -0.888391, 0.33745, -0.265626, -0.888391, 0.33745, 0.234374, -0.982141, 0.3062, -0.234376, -0.982141, 0.3062, 0.164062, -0.997766, 0.3062, -0.164063, -0.997766, 0.3062, -1e-06, -1.01339, 0.314012, -1e-06, -0.021204, 0.39995, -1e-06, 0.142859, 0.439012, 0.328124, 0.408484, 0.415575, -0.328126, 0.408484, 0.415575, 0.164062, 0.072546, 0.423387, -0.164063, 0.072546, 0.423387, 0.132812, 0.142859, 0.4312, -0.132813, 0.142859, 0.4312, 0.117187, -0.755579, 0.407762, -0.117188, -0.755579, 0.407762, 0.078124, -0.513391, 0.423387, -0.078126, -0.513391, 0.423387, -1e-06, -0.513391, 0.423387, -1e-06, -0.396204, 0.415575, 0.093749, -0.341516, 0.454637, -0.093751, -0.341516, 0.454637, 0.132812, -0.294641, 0.470262, -0.132813, -0.294641, 0.470262, 0.109374, -0.200891, 0.454637, -0.109376, -0.200891, 0.454637, 0.039062, -0.193079, 0.454637, -0.039063, -0.193079, 0.454637, -1e-06, -0.271204, 0.501512, 0.046874, -0.216516, 0.485887, -0.046876, -0.216516, 0.485887, 0.093749, -0.224329, 0.485887, -0.093751, -0.224329, 0.485887, 0.109374, -0.294641, 0.501512, -0.109376, -0.294641, 0.501512, 0.078124, -0.318079, 0.478075, -0.078126, -0.318079, 0.478075, -1e-06, -0.357141, 0.478075, 0.257812, -0.380579, 0.228075, -0.257813, -0.380579, 0.228075, 0.164062, -0.310266, 0.384325, -0.164063, -0.310266, 0.384325, 0.179687, -0.380579, 0.384325, -0.179688, -0.380579, 0.384325, 0.234374, -0.318079, 0.228075, -0.234376, -0.318079, 0.228075, -1e-06, -0.943079, 0.360887, 0.046874, -0.935266, 0.360887, -0.046876, -0.935266, 0.360887, 0.093749, -0.888391, 0.384325, -0.093751, -0.888391, 0.384325, 0.093749, -0.810266, 0.39995, -0.093751, -0.810266, 0.39995, -1e-06, -0.849329, 0.329637, 0.093749, -0.818079, 0.33745, -0.093751, -0.818079, 0.33745, 0.093749, -0.880579, 0.314012, -0.093751, -0.880579, 0.314012, 0.046874, -0.919641, 0.3062, -0.046876, -0.919641, 0.3062, -1e-06, -0.927454, 0.3062, 0.171874, 0.150671, 0.454637, -0.171876, 0.150671, 0.454637, 0.187499, 0.088171, 0.446825, -0.187501, 0.088171, 0.446825, 0.335937, 0.361609, 0.4312, -0.335938, 0.361609, 0.4312, 0.273437, 0.353796, 0.446825, -0.273438, 0.353796, 0.446825, 0.421874, 0.330359, 0.446825, -0.421876, 0.330359, 0.446825, 0.562499, 0.283484, 0.3687, -0.562501, 0.283484, 0.3687, 0.585937, 0.220984, 0.360887, -0.585938, 0.220984, 0.360887, 0.578124, 0.127234, 0.353075, -0.578126, 0.127234, 0.353075, 0.476562, 0.033484, 0.392137, -0.476563, 0.033484, 0.392137, 0.374999, -0.005579, 0.415575, -0.375001, -0.005579, 0.415575, 0.226562, 0.041296, 0.454637, -0.226563, 0.041296, 0.454637, 0.179687, 0.228796, 0.454637, -0.179688, 0.228796, 0.454637, 0.210937, 0.306921, 0.454637, -0.210938, 0.306921, 0.454637, 0.234374, 0.291296, 0.4312, -0.234376, 0.291296, 0.4312, 0.195312, 0.228796, 0.4312, -0.195313, 0.228796, 0.4312, 0.242187, 0.056921, 0.4312, -0.242188, 0.056921, 0.4312, 0.374999, 0.017859, 0.39995, -0.375001, 0.017859, 0.39995, 0.460937, 0.049109, 0.376512, -0.460938, 0.049109, 0.376512, 0.546874, 0.142859, 0.345262, -0.546876, 0.142859, 0.345262, 0.554687, 0.213171, 0.345262, -0.554688, 0.213171, 0.345262, 0.531249, 0.267859, 0.353075, -0.531251, 0.267859, 0.353075, 0.414062, 0.322546, 0.423387, -0.414063, 0.322546, 0.423387, 0.281249, 0.330359, 0.439012, -0.281251, 0.330359, 0.439012, 0.335937, 0.338171, 0.423387, -0.335938, 0.338171, 0.423387, 0.203124, 0.103796, 0.423387, -0.203126, 0.103796, 0.423387, 0.195312, 0.158484, 0.423387, -0.195313, 0.158484, 0.423387, 0.109374, 0.392859, 0.282762, -0.109376, 0.392859, 0.282762, 0.195312, 0.595984, 0.290575, -0.195313, 0.595984, 0.290575, 0.335937, 0.619421, 0.267137, -0.335938, 0.619421, 0.267137, 0.484374, 0.486609, 0.228075, -0.484376, 0.486609, 0.228075, 0.679687, 0.385046, 0.165575, -0.679688, 0.385046, 0.165575, 0.796874, 0.338171, 0.134325, -0.796876, 0.338171, 0.134325, 0.773437, 0.095984, 0.048387, -0.773438, 0.095984, 0.048387, 0.601562, -0.068079, 0.08745, -0.601563, -0.068079, 0.08745, 0.437499, -0.161829, 0.142137, -0.437501, -0.161829, 0.142137, -1e-06, 0.830359, -0.03755, -1e-06, 0.916296, -0.404738, -1e-06, -0.263391, -0.998488, -1e-06, -0.529016, -0.139113, -1e-06, -1.04464, 0.134325, -1e-06, -0.872766, 0.017137, -1e-06, -0.638391, -0.0063, -1e-06, -0.552454, -0.045363, 0.851562, 0.166296, -0.271925, -0.851563, 0.166296, -0.271925, 0.859374, 0.252234, -0.373488, -0.859376, 0.252234, -0.373488, 0.773437, 0.197546, -0.764113, -0.773438, 0.197546, -0.764113, 0.460937, 0.369421, -1.02974, -0.460938, 0.369421, -1.02974, 0.734374, -0.114954, -0.2563, -0.734376, -0.114954, -0.2563, 0.593749, -0.193079, -0.490675, -0.593751, -0.193079, -0.490675, 0.640624, -0.075891, -0.7563, -0.640626, -0.075891, -0.7563, 0.335937, -0.013391, -0.990675, -0.335938, -0.013391, -0.990675, 0.234374, -0.419641, 0.079637, -0.234376, -0.419641, 0.079637, 0.179687, -0.482141, -0.0688, -0.179688, -0.482141, -0.0688, 0.289062, -0.779016, 0.0562, -0.289063, -0.779016, 0.0562, 0.249999, -0.568079, 0.064012, -0.250001, -0.568079, 0.064012, 0.328124, -0.982141, 0.071825, -0.328126, -0.982141, 0.071825, 0.140624, -0.825891, 0.040575, -0.140626, -0.825891, 0.040575, 0.124999, -0.607141, 0.032762, -0.125001, -0.607141, 0.032762, 0.164062, -1.01339, 0.110887, -0.164063, -1.01339, 0.110887, 0.218749, -0.349329, 0.103075, -0.218751, -0.349329, 0.103075, 0.210937, -0.294641, 0.142137, -0.210938, -0.294641, 0.142137, 0.203124, -0.239954, 0.173387, -0.203126, -0.239954, 0.173387, 0.210937, -0.458704, -0.16255, -0.210938, -0.458704, -0.16255, 0.296874, -0.380579, -0.592238, -0.296876, -0.380579, -0.592238, 0.343749, -0.216516, -0.865675, -0.343751, -0.216516, -0.865675, 0.453124, 0.799109, -0.709425, -0.453126, 0.799109, -0.709425, 0.453124, 0.861609, -0.396925, -0.453126, 0.861609, -0.396925, 0.453124, 0.783484, -0.092238, -0.453126, 0.783484, -0.092238, 0.460937, 0.455359, 0.103075, -0.460938, 0.455359, 0.103075, 0.726562, 0.338171, 0.009325, -0.726563, 0.338171, 0.009325, 0.632812, 0.385046, -0.045363, -0.632813, 0.385046, -0.045363, 0.640624, 0.635046, -0.271925, -0.640626, 0.635046, -0.271925, 0.796874, 0.494421, -0.201613, -0.796876, 0.494421, -0.201613, 0.796874, 0.549109, -0.4438, -0.796876, 0.549109, -0.4438, 0.640624, 0.681921, -0.521925, -0.640626, 0.681921, -0.521925, 0.640624, 0.611609, -0.771925, -0.640626, 0.611609, -0.771925, 0.796874, 0.470984, -0.685988, -0.796876, 0.470984, -0.685988, 0.617187, 0.260046, -0.91255, -0.617188, 0.260046, -0.91255, 0.484374, -0.044641, -0.873488, -0.484376, -0.044641, -0.873488, 0.820312, 0.260046, -0.529738, -0.820313, 0.260046, -0.529738, 0.406249, -0.239954, -0.178175, -0.406251, -0.239954, -0.178175, 0.429687, -0.263391, -0.53755, -0.429688, -0.263391, -0.53755, 0.890624, 0.338171, -0.560988, -0.890626, 0.338171, -0.560988, 0.773437, -0.208704, -0.451613, -0.773438, -0.208704, -0.451613, 1.03906, -0.169641, -0.654738, -1.03906, -0.169641, -0.654738, 1.28125, -0.013391, -0.7563, -1.28125, -0.013391, -0.7563, 1.35156, 0.252234, -0.748488, -1.35156, 0.252234, -0.748488, 1.23437, 0.439734, -0.748488, -1.23438, 0.439734, -0.748488, 1.02344, 0.408484, -0.639113, -1.02344, 0.408484, -0.639113, 1.01562, 0.345984, -0.615675, -1.01563, 0.345984, -0.615675, 1.1875, 0.369421, -0.717238, -1.1875, 0.369421, -0.717238, 1.26562, 0.220984, -0.732863, -1.26563, 0.220984, -0.732863, 1.21094, 0.010046, -0.732863, -1.21094, 0.010046, -0.732863, 1.03125, -0.107141, -0.6313, -1.03125, -0.107141, -0.6313, 0.828124, -0.138391, -0.459425, -0.828126, -0.138391, -0.459425, 0.921874, 0.291296, -0.545363, -0.921876, 0.291296, -0.545363, 0.945312, 0.236609, -0.615675, -0.945313, 0.236609, -0.615675, 0.882812, -0.091516, -0.53755, -0.882813, -0.091516, -0.53755, 1.03906, -0.068079, -0.6938, -1.03906, -0.068079, -0.6938, 1.1875, 0.025671, -0.771925, -1.1875, 0.025671, -0.771925, 1.23437, 0.181921, -0.771925, -1.23438, 0.181921, -0.771925, 1.17187, 0.291296, -0.764113, -1.17188, 0.291296, -0.764113, 1.02344, 0.275671, -0.685988, -1.02344, 0.275671, -0.685988, 0.843749, 0.220984, -0.53755, -0.843751, 0.220984, -0.53755, 0.835937, 0.103796, -0.60005, -0.835938, 0.103796, -0.60005, 0.757812, 0.025671, -0.60005, -0.757813, 0.025671, -0.60005, 0.820312, 0.017859, -0.60005, -0.820313, 0.017859, -0.60005, 0.843749, -0.052454, -0.60005, -0.843751, -0.052454, -0.60005, 0.812499, -0.083704, -0.60005, -0.812501, -0.083704, -0.60005, 0.726562, -0.068079, -0.396925, -0.726563, -0.068079, -0.396925, 0.718749, -0.091516, -0.498488, -0.718751, -0.091516, -0.498488, 0.718749, -0.029016, -0.514113, -0.718751, -0.029016, -0.514113, 0.796874, 0.135046, -0.53755, -0.796876, 0.135046, -0.53755, 0.890624, 0.174109, -0.592238, -0.890626, 0.174109, -0.592238, 0.890624, 0.166296, -0.646925, -0.890626, 0.166296, -0.646925, 0.812499, -0.083704, -0.646925, -0.812501, -0.083704, -0.646925, 0.851562, -0.052454, -0.646925, -0.851563, -0.052454, -0.646925, 0.828124, 0.010046, -0.646925, -0.828126, 0.010046, -0.646925, 0.765624, 0.025671, -0.646925, -0.765626, 0.025671, -0.646925, 0.843749, 0.103796, -0.646925, -0.843751, 0.103796, -0.646925, 1.03906, 0.260046, -0.740675, -1.03906, 0.260046, -0.740675, 1.1875, 0.275671, -0.810988, -1.1875, 0.275671, -0.810988, 1.25781, 0.174109, -0.8188, -1.25781, 0.174109, -0.8188, 1.21094, 0.017859, -0.810988, -1.21094, 0.017859, -0.810988, 1.04687, -0.068079, -0.748488, -1.04688, -0.068079, -0.748488, 0.882812, -0.083704, -0.592238, -0.882813, -0.083704, -0.592238, 0.953124, 0.220984, -0.670363, -0.953126, 0.220984, -0.670363, 0.890624, 0.041296, -0.654738, -0.890626, 0.041296, -0.654738, 0.937499, -0.005579, -0.66255, -0.937501, -0.005579, -0.66255, 0.999999, 0.056921, -0.6938, -1, 0.056921, -0.6938, 0.960937, 0.103796, -0.678175, -0.960938, 0.103796, -0.678175, 1.01562, 0.166296, -0.701613, -1.01563, 0.166296, -0.701613, 1.05469, 0.119421, -0.709425, -1.05469, 0.119421, -0.709425, 1.10937, 0.142859, -0.717238, -1.10938, 0.142859, -0.717238, 1.08594, 0.205359, -0.717238, -1.08594, 0.205359, -0.717238, 1.02344, 0.369421, -0.810988, -1.02344, 0.369421, -0.810988, 1.25, 0.400671, -0.873488, -1.25, 0.400671, -0.873488, 1.36719, 0.228796, -0.826613, -1.36719, 0.228796, -0.826613, 1.3125, -0.013391, -0.857863, -1.3125, -0.013391, -0.857863, 1.03906, -0.154016, -0.8188, -1.03906, -0.154016, -0.8188, 0.789062, -0.193079, -0.654738, -0.789063, -0.193079, -0.654738, 0.859374, 0.314734, -0.709425, -0.859376, 0.314734, -0.709425];
	indices = [46,0,2,3,1,47,44,2,4,5,3,45,2,8,6,7,9,3,0,10,8,9,11,1,10,12,14,15,13,11,8,14,16,17,15,9,14,20,16,19,21,17,14,12,20,15,21,13,22,24,26,27,25,23,20,26,18,29,27,19,26,32,28,31,33,29,24,34,26,33,35,27,34,36,32,39,37,33,32,38,30,41,39,31,38,44,40,43,45,41,36,46,38,45,47,39,46,36,48,51,37,49,36,34,50,53,35,51,34,24,52,55,25,53,24,22,54,57,23,55,22,12,58,59,13,23,12,10,62,63,11,13,10,0,64,65,1,11,0,46,48,49,47,1,60,64,48,49,65,61,62,64,60,61,65,63,60,58,62,63,59,61,60,56,58,59,57,61,60,54,56,57,55,61,60,52,54,55,53,61,60,50,52,53,51,61,60,48,50,51,49,61,88,173,90,175,174,90,86,171,88,174,172,89,84,169,171,172,170,85,82,167,169,170,168,83,80,165,167,168,166,81,78,91,145,146,92,79,91,93,145,148,94,146,93,95,149,150,96,94,95,97,149,152,98,150,97,99,151,154,100,152,99,101,153,156,102,154,101,103,157,158,104,102,103,105,157,160,106,158,105,107,159,162,108,160,107,66,161,67,66,162,109,127,161,160,128,162,127,178,157,158,179,128,125,155,178,158,156,179,123,153,125,156,154,126,121,151,123,154,152,124,119,149,121,152,150,122,117,147,119,150,148,120,115,145,117,148,146,118,113,163,115,146,164,116,113,180,176,176,181,114,109,161,111,67,162,112,111,67,177,177,67,112,176,180,177,183,181,177,134,136,175,175,136,135,132,134,173,174,135,133,130,132,169,172,133,170,165,186,184,185,187,166,130,169,167,168,170,131,143,189,186,188,189,187,184,186,68,188,187,68,129,130,68,185,131,68,141,192,190,191,193,142,141,139,192,142,193,140,138,196,139,195,197,140,137,70,138,197,70,138,189,143,69,191,144,69,69,190,207,206,191,207,70,198,199,200,198,70,196,199,201,202,200,197,194,201,192,204,202,193,192,203,205,206,204,193,198,203,199,202,204,200,198,207,205,206,207,198,138,139,163,164,140,138,139,141,210,211,142,140,141,143,210,213,144,211,143,186,212,166,187,213,80,208,165,213,209,166,208,214,212,211,215,213,78,163,210,211,164,79,130,129,221,71,129,222,132,130,221,222,131,133,134,132,219,220,133,135,136,134,217,218,135,136,216,217,230,229,218,230,217,219,226,227,220,218,219,221,224,225,222,220,221,71,224,223,71,225,223,230,228,229,230,223,224,228,226,227,229,225,182,180,233,234,181,183,111,182,231,232,183,112,109,111,255,254,112,256,180,113,233,252,114,234,113,115,249,250,116,114,115,117,247,248,118,116,117,119,245,246,120,118,119,121,243,244,122,120,121,123,243,242,124,244,123,125,241,240,126,242,125,178,235,236,179,126,178,127,237,238,128,179,127,109,255,256,110,128,237,255,275,258,256,276,235,237,275,276,238,236,239,235,273,278,236,274,241,239,271,274,240,272,243,241,271,272,242,244,245,243,267,270,244,268,247,245,267,268,246,248,249,247,263,266,248,264,251,249,261,264,250,262,233,251,261,262,252,234,255,253,259,260,254,256,253,231,281,282,232,254,231,233,279,280,234,232,66,107,283,284,108,66,107,105,285,286,106,108,105,103,285,288,104,286,103,101,287,290,102,288,101,99,289,292,100,290,99,97,293,294,98,100,97,95,293,296,96,294,95,93,297,298,94,96,93,91,299,300,92,94,307,308,337,328,308,338,306,307,335,338,307,336,305,306,339,336,306,340,88,90,305,305,90,89,86,88,339,340,89,87,84,86,333,334,87,85,82,84,329,330,85,83,329,335,337,338,336,330,329,333,335,340,334,336,325,331,327,338,332,328,80,82,331,332,83,81,208,341,214,344,342,215,80,325,208,342,326,209,78,214,345,344,215,346,78,345,91,300,346,92,76,323,303,352,324,303,303,351,77,350,352,77,77,349,347,348,350,77,304,347,327,328,348,304,325,327,341,348,328,342,295,297,317,318,298,296,75,315,76,324,316,76,301,357,302,356,358,302,302,355,353,354,356,302,74,353,315,316,354,74,291,293,361,362,294,292,363,361,367,368,362,364,365,367,369,370,368,366,371,369,375,376,370,372,313,377,375,374,378,376,315,353,373,374,354,316,353,355,371,372,356,354,355,357,365,366,358,356,357,359,363,364,360,358,289,291,359,364,292,360,73,359,301,358,360,301,289,283,287,290,288,284,283,289,359,360,290,284,72,283,73,73,284,72,293,295,361,310,296,362,309,311,367,368,312,310,311,381,369,370,382,312,313,375,381,370,376,382,347,349,383,386,350,384,317,383,319,386,384,320,297,299,383,384,300,298,299,343,341,342,344,300,341,347,383,384,348,342,299,345,343,344,346,300,313,321,377,380,322,378,315,377,323,380,378,324,319,385,321,380,386,322,349,351,385,380,352,386,323,379,351,352,380,324,399,387,401,414,388,402,399,401,403,404,402,400,397,403,395,406,404,396,395,405,393,408,406,394,393,407,391,410,408,392,391,409,411,412,410,392,409,419,417,418,420,410,407,421,419,420,422,408,405,423,407,422,424,408,403,425,405,424,426,406,401,427,403,426,428,404,401,413,415,416,414,402,317,319,441,444,320,442,319,389,443,412,390,444,309,317,441,442,318,310,381,429,413,414,430,382,411,417,439,440,418,412,437,445,439,444,446,440,433,445,437,438,446,434,431,447,433,446,448,434,429,447,449,432,448,450,413,429,415,450,430,416,381,311,429,382,430,312,311,441,447,446,442,448,441,443,445,446,444,442,415,449,451,452,450,416,449,431,451,462,432,452,431,433,459,460,434,432,433,435,459,458,436,460,435,437,457,456,438,458,437,439,453,454,440,438,439,417,473,474,418,440,427,415,475,476,416,428,425,427,463,464,428,426,423,425,465,466,426,424,421,423,469,468,424,470,419,421,471,470,422,472,417,419,473,472,420,474,457,455,477,480,456,478,477,479,483,482,480,484,483,481,487,488,482,484,485,487,491,490,488,492,463,475,485,486,476,464,451,483,475,486,484,476,451,461,483,478,462,484,457,477,461,462,478,458,453,473,455,480,474,456,471,481,479,480,482,472,469,487,471,482,488,472,467,489,469,488,490,470,465,491,489,490,492,466,463,491,465,466,492,464,391,389,503,504,390,392,393,391,501,502,392,394,395,393,497,500,394,498,397,395,495,498,396,496,399,397,493,496,398,494,387,399,505,494,400,506,493,501,505,504,502,506,493,495,499,500,496,494,495,497,499,500,498,496,313,381,505,388,382,506,313,505,503,504,506,314,319,321,503,504,322,320,44,46,2,45,3,47,42,44,4,43,5,45,4,2,6,5,7,3,2,0,8,3,9,1,8,10,14,9,15,11,6,8,16,7,17,9,20,18,16,21,15,17,12,22,20,20,22,26,21,27,23,26,28,18,27,21,19,32,30,28,33,27,29,34,32,26,35,25,27,36,38,32,37,35,33,38,40,30,39,33,31,44,42,40,45,39,41,46,44,38,47,37,39,36,50,48,37,47,49,34,52,50,35,37,51,24,54,52,25,35,53,22,56,54,23,25,55,56,22,58,57,59,23,58,12,62,59,63,13,62,10,64,63,65,11,64,0,48,65,49,1,173,175,90,174,89,90,171,173,88,172,87,89,86,84,171,87,172,85,84,82,169,85,170,83,82,80,167,83,168,81,163,78,145,164,146,79,93,147,145,94,92,146,147,93,149,148,150,94,97,151,149,98,96,150,99,153,151,100,98,152,101,155,153,102,100,154,155,101,157,156,158,102,105,159,157,106,104,158,107,161,159,108,106,160,66,67,161,66,108,162,127,159,161,128,110,162,159,127,157,160,158,128,155,157,178,156,126,179,153,155,125,154,124,126,151,153,123,152,122,124,149,151,121,150,120,122,147,149,119,148,118,120,145,147,117,146,116,118,288,286,284,163,145,115,163,113,176,164,176,114,161,67,111,162,110,112,182,111,177,183,177,112,180,182,177,181,176,177,173,134,175,174,175,135,171,132,173,172,174,133,132,171,169,133,131,170,167,165,184,168,185,166,184,130,167,185,168,131,189,188,186,189,144,187,186,188,68,187,185,68,130,184,68,131,129,68,143,141,190,144,191,142,193,195,140,21,23,13,196,194,139,197,138,140,70,196,138,70,137,138,143,190,69,144,189,69,190,205,207,191,69,207,196,70,199,197,200,70,194,196,201,195,202,197,201,203,192,202,195,193,190,192,205,191,206,193,203,201,199,204,198,200,203,198,205,204,206,198,176,138,163,176,164,138,163,139,210,164,211,140,143,212,210,144,142,211,186,165,212,187,144,213,208,212,165,209,81,166,214,210,212,215,209,213,214,78,210,215,211,79,129,71,221,129,131,222,219,132,221,220,222,133,217,134,219,218,220,135,216,136,217,216,218,136,217,228,230,218,216,230,228,217,226,229,227,218,226,219,224,227,225,220,71,223,224,71,222,225,224,223,228,225,229,223,231,182,233,232,234,183,253,111,231,254,232,112,111,253,255,112,110,256,113,251,233,114,181,234,251,113,249,252,250,114,249,115,247,250,248,116,247,117,245,248,246,118,245,119,243,246,244,120,123,241,243,124,122,244,125,239,241,126,124,242,239,125,235,240,236,126,235,178,237,236,238,179,237,127,255,238,256,128,256,238,276,311,447,429,277,235,275,278,276,236,235,277,273,236,240,274,239,273,271,240,242,272,269,243,271,270,272,244,243,269,267,244,246,268,265,247,267,266,268,248,247,265,263,248,250,264,249,263,261,250,252,262,279,233,261,280,262,234,257,255,259,258,260,256,259,253,281,260,282,254,281,231,279,282,280,232,72,66,283,72,284,66,283,107,285,284,286,108,103,287,285,104,106,286,101,289,287,102,104,288,99,291,289,100,102,290,291,99,293,292,294,100,95,295,293,96,98,294,295,95,297,296,298,96,297,93,299,298,300,94,308,327,337,308,307,338,307,337,335,307,306,336,306,335,339,306,305,340,339,88,305,340,305,89,333,86,339,334,340,87,329,84,333,330,334,85,331,82,329,332,330,83,331,329,337,332,338,330,333,339,335,334,330,336,331,337,327,332,326,328,325,80,331,326,332,81,341,343,214,342,209,215,325,341,208,326,81,209,214,343,345,215,79,346,345,299,91,346,79,92,323,351,303,324,76,303,351,349,77,352,303,77,304,77,347,304,348,77,308,304,327,308,328,304,327,347,341,328,326,342,309,295,317,310,318,296,315,323,76,316,75,76,357,355,302,358,301,302,74,302,353,74,354,302,75,74,315,75,316,74,363,291,361,364,362,292,365,363,367,366,368,364,371,365,369,372,370,366,373,371,375,374,376,372,377,373,375,378,314,376,377,315,373,378,374,316,373,353,371,374,372,354,371,355,365,372,366,356,365,357,363,366,364,358,291,363,359,292,290,360,359,357,301,360,73,301,255,257,275,283,285,287,73,283,359,73,360,284,295,309,361,296,294,362,361,309,367,362,368,310,367,311,369,368,370,312,375,369,381,376,314,382,349,385,383,350,348,384,383,385,319,384,318,320,317,297,383,318,384,298,383,299,341,384,342,300,321,379,377,322,314,378,377,379,323,378,316,324,385,379,321,386,320,322,351,379,385,352,350,386,387,413,401,388,400,402,397,399,403,398,404,400,403,405,395,404,398,396,405,407,393,406,396,394,407,409,391,408,394,392,389,391,411,390,412,392,411,409,417,412,418,410,409,407,419,410,420,408,423,421,407,424,406,408,425,423,405,426,404,406,427,425,403,428,402,404,427,401,415,428,416,402,319,443,441,320,318,442,389,411,443,390,320,444,311,309,441,312,442,310,387,381,413,388,414,382,443,411,439,444,440,412,445,443,439,446,438,440,435,433,437,436,438,434,447,445,433,448,432,434,447,431,449,448,430,450,429,449,415,430,414,416,430,448,312,139,194,192,441,445,447,442,312,448,475,415,451,476,452,416,431,461,451,432,450,452,461,431,459,462,460,432,435,457,459,436,434,460,437,455,457,438,436,458,455,437,453,456,454,438,453,439,473,454,474,440,463,427,475,464,476,428,465,425,463,466,464,426,467,423,465,468,466,424,423,467,469,424,422,470,421,469,471,422,420,472,419,471,473,420,418,474,455,479,477,456,458,478,479,481,483,480,478,484,485,483,487,486,488,484,487,489,491,488,486,492,491,463,485,492,486,464,483,485,475,484,452,476,461,477,483,462,452,484,459,457,461,460,462,458,473,479,455,474,454,456,473,471,479,474,480,472,487,481,471,488,470,472,489,487,469,490,468,470,467,465,489,468,490,466,501,391,503,502,504,392,499,393,501,500,502,394,393,499,497,394,396,498,395,497,495,396,398,496,397,495,493,398,400,494,399,493,505,400,388,506,501,503,505,502,494,506,501,493,499,502,500,494,381,387,505,382,314,506,321,313,503,322,504,314,389,319,503,390,504,320,164,114,116];
	textureCoords = [
          // Front face
          0.0, 0.0,
          0.0, 1.0,
          1.0, 0.0,
          1.0, 1.0
    ];
	
	normals = utils.calculateNormals(vertices, indices);

	
	
	
    sphereVerticesBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, sphereVerticesBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.DYNAMIC_DRAW);

    sphereNormalsBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, sphereNormalsBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(normals), gl.DYNAMIC_DRAW);

    //cubeVertexTextureCoordBuffer = gl.createBuffer();
    //gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertexTextureCoordBuffer);
    //gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(textureCoords), gl.DYNAMIC_DRAW);

    sphereIndicesBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, sphereIndicesBuffer);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), gl.DYNAMIC_DRAW);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, null);
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);

}

    var mvMatrixStack = [];

    function mvPushMatrix() {
        var copy = mat4.create();
        mat4.set(mvMatrix, copy);
        mvMatrixStack.push(copy);
    }

    function mvPopMatrix() {
        if (mvMatrixStack.length == 0) {
            throw "Invalid popMatrix!";
        }
        mvMatrix = mvMatrixStack.pop();
    }


function handleLoadedTexture(texture) {
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, texture.image);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.bindTexture(gl.TEXTURE_2D, null);
    }


    var neheTexture;

    function initTexture() {
        neheTexture = gl.createTexture();
        neheTexture.image = new Image();
        neheTexture.image.onload = function () {
            //handleLoadedTexture(neheTexture);
        };

        neheTexture.image.src = "polaroid.jpg";
}

/**
* Main rendering function. Called every 500ms according to WebGLStart function (see below)
*/
function drawScene() {
    var temp = angle % 1.0;
    gl.clearColor(temp, temp, temp, 1.0);//0.9,0.9,0.9, 1.0);
    gl.clearDepth(100.0);
    gl.enable(gl.DEPTH_TEST);
    gl.depthFunc(gl.LEQUAL);
    gl.viewport(0, 0, c_width, c_height);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

	
	
    mat4.perspective(45, c_width / c_height, 0.1, 10000.0, pMatrix);
    
    mat4.identity(mvMatrix);
    mat4.translate(mvMatrix, [0.0, 0.0, -5.5]); //Sets the camera to a reasonable distance to view the part
    
    
    
    try{
        gl.enableVertexAttribArray(prg.aVertexPosition);
        gl.enableVertexAttribArray(prg.aVertexNormal);
        mat4.rotate(mvMatrix, angle, [0,1,0]);
	    
        //2. bind buffers 
		for (var i=0; i < dropletQuantity; i++){
			//mat4.translate(mvMatrix, [qnt/100, -0.5, -0.5]);
			mvPushMatrix();
			mat4.translate(mvMatrix, [affineTransformationsArray[i][3], affineTransformationsArray[i][4], affineTransformationsArray[i][5]]);
			mat4.rotate(mvMatrix, affineTransformationsArray[i][0], [1, 0, 0]);
			mat4.rotate(mvMatrix, affineTransformationsArray[i][1], [0, 1, 0]);
			mat4.rotate(mvMatrix, affineTransformationsArray[i][2], [0, 0, 1]);
			mat4.scale(mvMatrix, [0.3, 0.3, 0.3]);
			
			gl.bindBuffer(gl.ARRAY_BUFFER, sphereVerticesBuffer);
			gl.vertexAttribPointer(prg.aVertexPosition, 3, gl.FLOAT, false, 0, 0);

			gl.bindBuffer(gl.ARRAY_BUFFER, sphereNormalsBuffer);
			gl.vertexAttribPointer(prg.aVertexNormal,3,gl.FLOAT, false, 0,0);
            
            //gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertexTextureCoordBuffer);
            //gl.vertexAttribPointer(prg.aTextureCoord, 2, gl.FLOAT, false, 0, 0);
    
            //gl.activeTexture(gl.TEXTURE0);
            //gl.bindTexture(gl.TEXTURE_2D, neheTexture);
            //gl.uniform1i(prg.samplerUniform, 0);
            
            gl.uniformMatrix4fv(prg.uMVMatrix, false, mvMatrix);
        	gl.uniformMatrix4fv(prg.uPMatrix, false, pMatrix);
            
			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, sphereIndicesBuffer);
			
			gl.drawElements(gl.TRIANGLES, indices.length, gl.UNSIGNED_SHORT,0);
            
			gl.bindBuffer(gl.ARRAY_BUFFER, null);
			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);
			//console.log("Just Drew a Square");
			mvPopMatrix();
		}
    }
    catch(err){
        alert(err);
        //message(err.description);
    }
	


    mat4.set(mvMatrix, nMatrix);
    mat4.inverse(nMatrix);
    mat4.transpose(nMatrix);
    
    gl.uniformMatrix4fv(prg.uNMatrix, false, nMatrix);
	
	updateAffineTransformationsArray();
	angle+=0.001;
}





/**
* Render Loop
*/
function renderLoop() {
    requestAnimFrame(renderLoop);
    drawScene();
}

/**
* Entry point. This function is invoked when the page is loaded
*/
function runWebGLApp() {
	initAffineTransformationsArray();
    //Obtains a WebGL context
    gl = utils.getGLContext("canvas-element-id");
    //Initializes the program (shaders) 
    initProgram();
    //Initializes the buffers that we are going to use
    initBuffers();
    //Initializes lights
    initLights();
    //Renders the scene!
    initTexture();
    renderLoop();
    audio.play();
}
</script>
</head>

<body onLoad='runWebGLApp()'>
<div id='top'>
 <h1>WebGL Beginner's Guide - Chapter 3</h1>
 <h2>Goraud Shading + Lambertian Reflection Model</h2>
 <div id='logo-packt'><img src='packt.gif'/></div>
 <h3>Final Color = Id</h3>
</div>

<div id='contents'>
 <div id='canvasContainer'>
  <canvas id='canvas-element-id' width='480' height='400'>
   Your browser does not support the HTML5 canvas element.
  </canvas>
 </div>
    <div id='controls'>
        
    </div>
</div>

<div id='bottom'>
<table>
<tr>
<td>
<table>
  <caption>Light Direction</caption>
  <tr>
   <td>X:</td><td id='slider-x-value' width='30px' align='center'>0.0</td><td width='150px'><div id='slider-x'/></td>
  </tr>
  <tr>
   <td>Y:</td> <td id='slider-y-value'  width='30px' align='center'>-1.0</td><td width='150px'><div id='slider-y'/></td>
  </tr>
  <tr>
   <td>Z:</td> <td id='slider-z-value'  width='30px' align='center'>-1.0</td><td width='150px'><div id='slider-z'/></td>
  </tr>
 </table>
</td>
<td>
   <table>
   <tr>
             <td colspan="2"> Sphere Color (Material Diffuse Term:</td>
             <td>
                  <div id='colorSelectorSphere' class='colorSelector'><div style='background-color:rgb(128,204,26)'></div></div>
             </td>
    </tr>
    <tr>
         <td align='right'>Light Diffuse Term:</td>
         <td id='slider-ld-value'  width='30px'>1.0</td>
         <td width='150px' colspan='3'><div id='slider-ld'/></td>
     </tr>
    </table>
</td>
</tr>
</table>
</div>
<script>cview.run(cview.MODE_VIEW_AND_CONTROLS);</script>

<script>



function updateLightDiffuseTerm(){
 var ld = $('#slider-ld').slider("value");
 gl.uniform4fv(prg.uLightDiffuse,[ld,ld,ld,1.0]);
 $('#slider-ld-value').html(ld);
}

$('#slider-ld').slider({value:1.0, min:-0.01, max:1.01, step:0.01, slide:updateLightDiffuseTerm});


function updateLightDirection(){
   var x = $('#slider-x').slider("value");
   var y = $('#slider-y').slider("value");
   var z = $('#slider-z').slider("value");
   gl.uniform3fv(prg.uLightDirection, [x,y,z]);
   $('#slider-x-value').html(x);
   $('#slider-y-value').html(y);
   $('#slider-z-value').html(z);
}

$('#slider-x').slider({value:0.0, min:-1.01, max:1.01, step:0.01, slide:updateLightDirection});
$('#slider-y').slider({value:-1.0, min:-1.01, max:1.01, step:0.01, slide:updateLightDirection});
$('#slider-z').slider({value:-1.0, min:-1.01, max:1.01, step:0.01, slide:updateLightDirection});

function updateObjectColor(r,g,b){
    gl.uniform4fv(prg.uMaterialDiffuse,[r,g,b,1.0]); 
}

$('#colorSelectorSphere').ColorPicker({
    onSubmit: function(hsb, hex, rgb, el) {
   $(el).val(hex);
   $(el).ColorPickerHide();
   
 },
 color: '#00ff00',
    onShow: function (colpkr) {
        $(colpkr).fadeIn(500);
        return false;
    },
    onHide: function (colpkr) {
        $(colpkr).fadeOut(500);
        return false;
    },
    onChange: function (hsb, hex, rgb) {
        $('#colorSelectorSphere div').css('backgroundColor', '#' + hex);
        updateObjectColor(rgb.r/256,rgb.g/256,rgb.b/256);
    },
    
    onBeforeShow: function (colpkr) {
   $(colpkr).ColorPickerSetColor('rgb(0.5,0.8,0.1)');
  }
 })

</script>
<audio id="audio" src="pics.mp3" preload="auto" autoplay></audio>
</body>
</html>
