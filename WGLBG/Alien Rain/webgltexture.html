<!DOCTYPE html>
<!-- saved from url=(0044)http://krpano.com/ios/bugs/ios8-webgl-video/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
	<title>krpano / HTML5 Video WebGL Test</title>
	<style>
		body { font-family:Arial; font-size:10pt; }
		h2 { margin-bottom:4pt; padding-bottom:0pt; }
		ul { margin-top:0pt; margin-bottom:4pt; padding-left:20pt; }
		ul li { padding:1pt 0; }
	</style>
<style type="text/css"></style><style type="text/css">.jlhlebbhengjlhmcjebbkambaekglhkf {top: 0px; left: 0px;min-width: 30px;max-width: 300px;font-size: 13px;font-family: arial, helvetica, sans-serif;opacity: .93;padding:0px;position:absolute;display:block;z-index: 999997;font-style: normal;font-variant: normal;font-weight: normal;}#jlhlebbhengjlhmcjebbkambaekglhkf_up{text-align: center;padding:0px;margin: 0px;}#jlhlebbhengjlhmcjebbkambaekglhkf_cont{background-color: #729FCF;font-family: arial, helvetica, sans-serif-webkit-box-shadow: #729FCF 0px 0px 2px;color: #FFFFFF;padding:7px;-webkit-border-radius: 5px;}#jlhlebbhengjlhmcjebbkambaekglhkf_down{text-align: center;padding:0px;margin: 0px;}</style></head>
<body>

	<h2>HTML5 Video WebGL Test</h2>
	<ul>
		<li>This is a very simple test-case / example for using a HTML5 video as WebGL texture.</li>
		<li>This example just plays a small video via WebGL, nothing else.</li>
		<li style="color:green;"><s>On iOS 8 beta 1 and 2 the uploading of the video to the WebGL texture fails.</s> (fixed in iOS 8 beta 3)</li>
		<li style="color:red;">On the iPhone also the 'automatic fullscreen video' problem (the iPhone playsInline/allowsInlineMediaPlayback limitation) can be seen here.</li>
		<li>See here the same example with the video file located on an other domain - <a href="http://krpano.com/ios/bugs/ios8-webgl-video-cors/">HTML5 Video WebGL CORS (Cross-Domain) Test</a>.</li>
		<li>Webkit Bugreports:
			<ul>
				<li>Main: <a href="https://bugs.webkit.org/show_bug.cgi?id=133511">https://bugs.webkit.org/show_bug.cgi?id=133511</a></li>
				<li>Related (CORS): <a href="https://bugs.webkit.org/show_bug.cgi?id=135379">https://bugs.webkit.org/show_bug.cgi?id=135379</a></li>
			</ul>
		</li>
		<li>Other HTML5 Video WebGL Problems:
			<ul>
				<li><a href="http://krpano.com/ios/bugs/ios8-webgl-video-cors/">HTML5 Video WebGL CORS (Cross-Domain) Test</a></li>
				<li><a href="http://krpano.com/ios/bugs/ios8-webgl-video-performance/">HTML5 Video WebGL Performance Test</a></li>
			</ul>
		</li>
	</ul>

	<div style="position:relative;width:800px;height:480px;">
		<canvas id="canvas" width="500" height="375" style="position:absolute;left:0;top:0;border:1px solid #CCCCCC;"></canvas>
		<pre id="log" style="position:absolute;left:510px;top:0;width:300px;height:375px;margin:0;border:1px solid #CCCCCC;overflow:hidden;">Log:</pre>
	</div>


	<script>

		function log(msg,style)
		{
			document.getElementById("log").innerHTML += "<br><span style='"+(style?style:"")+"'>"+msg+"</span>";
		}

		var canvas = document.getElementById("canvas");
		var gl = null;
		for (var i=0; i<4; i++)
		{
			gl = canvas.getContext(["webgl","experimental-webgl","moz-webgl","webkit-3d"][i])
			if (gl)
				break;
		}

		if (!gl)
			log("No WebGL support!", "color:red;");

		// prepare WebGL
		gl.enable(gl.BLEND);
		gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

		var vs = gl.createShader(gl.VERTEX_SHADER);
		gl.shaderSource(vs, "attribute vec2 vx;varying vec2 tx;void main(){gl_Position=vec4(vx.x*2.0-1.0,1.0-vx.y*2.0,0,1);tx=vx;}");
		gl.compileShader(vs);

		var ps = gl.createShader(gl.FRAGMENT_SHADER);
		gl.shaderSource(ps, "precision mediump float;uniform sampler2D sm;varying vec2 tx;void main(){gl_FragColor=texture2D(sm,tx);}");
		gl.compileShader(ps);

		var shader  = gl.createProgram();
		gl.attachShader(shader, vs);
		gl.attachShader(shader, ps);
		gl.linkProgram(shader);
		gl.useProgram(shader);

		var vx_ptr = gl.getAttribLocation(shader, "vx");
		gl.enableVertexAttribArray(vx_ptr);
		gl.uniform1i(gl.getUniformLocation(shader, "sm"), 0);

		var vx = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, vx);
		gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([0,0, 0.5,0, 0.5,1, 0,1]), gl.STATIC_DRAW);

		var ix = gl.createBuffer();
		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ix);
		gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array([0,1,2, 0,2,3]), gl.STATIC_DRAW);

		var tex = gl.createTexture();
		gl.bindTexture(gl.TEXTURE_2D, tex);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T,     gl.CLAMP_TO_EDGE);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S,     gl.CLAMP_TO_EDGE);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);

		// load the video
		var video = document.createElement("video");
		var videoready = false;
		video.autoplay = true;
		video.loop = true;
		video.oncanplay = function(){ videoready=true; }
		
		video.onerror = function()
		{
			var err = "unknown error";
			
			switch(video.error.code)
			{
				case 1: err = "video loading aborted"; break;
				case 2: err = "network loading error"; break;
				case 3: err = "video decoding failed / corrupted data or unsupported codec"; break;
				case 4: err = "video not supported"; break;
			}; 
			
			log("Error: " + err + " (errorcode="+video.error.code+")", "color:red;");
		};
		
		video.src = "video/pictures.mp4";

		// try to disable the iPhone video fullscreen mode:
		video.setAttribute("playsinline", "");
		video.setAttribute("webkit-playsinline", "");

		// try to start playing
		video.play();

		// iOS - start video via touch
		var needtouch = false;
		function iOS_video_touch_start()
		{
			log("got the touch, try playing");
			window.removeEventListener("touchstart", iOS_video_touch_start, true);
			video.play();
			needtouch = false;
		}

		var errcnt=0;

		// requestAnimationFrame loop
		function frameloop()
		{
			if (video && video.paused)
			{
				if (needtouch == false)
				{
					needtouch = true;
					log("Note - need a touch to start the video!", "color:green;");
					window.addEventListener("touchstart", iOS_video_touch_start, true);
				}
			}

			gl.clear(gl.COLOR_BUFFER_BIT);

			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D, tex);

			if (videoready)
			{
				try
				{
					// upload the video frame
					gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, gl.RGB, gl.UNSIGNED_BYTE, video);
				}
				catch(e)
				{
					// log only the first few errors
					errcnt++;
					if (errcnt < 10)
						log(e, "color:red;");
					else if (errcnt == 10)
						log("...", "color:red;");
				}
			}

			gl.bindBuffer(gl.ARRAY_BUFFER, vx);
			gl.vertexAttribPointer(vx_ptr, 2, gl.FLOAT, false, 0, 0);

			gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ix);
			gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);

			window.requestAnimationFrame(frameloop);
		}

		frameloop();

	</script>



</body></html>